# 要件定義書：Notion注文書PDF・メール自動生成ツール

## 1. 概要

本プロジェクトは、Notionデータベースで管理されている注文情報を基に、**注文書PDF**と送付用メールを自動生成するデスクトップアプリケーションを開発することを目的とする。手作業による注文書作成とメール送付のプロセスを自動化し、業務効率を向上させる。

## 2. 機能要件

### 2.1. GUI機能
ユーザーが直感的に操作できるGUIを提供する。アプリケーションは起動時に設定ファイルの妥当性を検証し、不備があればエラーを通知する。

- **メイン画面**:
    - **部署名フィルター**: データを取得する部署を選択できる。
    - **送信者アカウント選択**: 複数のメールアカウントから送信元を選択できる。部署に応じてデフォルトのアカウントが自動で選択される。
    - **データ取得ボタン**: Notionから最新の注文情報を取得・更新する。
    - **仕入先リスト**: 取得したデータから仕入先を一覧表示する。ユーザーが仕入先を選択すると、注文書PDFが自動生成される。
    - **注文内容リスト**: 選択した仕入先の注文アイテム詳細を表示する。
    - **プレビューエリア**: 生成された注文書の宛先、担当者、ファイル名などを表示する。
    - **メール送信ボタン**: プレビュー内容を確認後、生成したPDFを添付したメールを送信する。
    - **通知メッセージエリア**: アプリケーションの操作ログや結果を表示する。
    - **設定ボタン**: 設定画面を開く。

- **設定画面**:
    - **メールアカウント管理**: 送信に使用するメールアカウント（表示名、メールアドレス、パスワード）の追加・編集・削除を行う。
    - **部署設定**: 部署名の追加・編集・削除、および部署ごとの電話ガイダンス番号を設定する。
    - **デフォルト送信者設定**: 部署ごとに、デフォルトで使用するメールアカウントを割り当てる。

### 2.2. Notion連携機能

- 指定されたNotionの**注文管理データベース**から情報を取得する。
- APIを通じて、以下の条件でデータをフィルタリングする。
    - **発注判定**: 「要発注」と判定されたアイテム。
    - **部署名**: GUIで選択された部署名。
    - **仕入先**: **仕入先データベース**に正しく関連付けられていること。
- メール送信後、対象アイテムのNotionページにある「**発注日**」プロパティを今日の日付に更新する機能を持つ。

### 2.3. PDF生成機能

- 取得した注文情報（仕入先名、担当者名、品番、数量など）と送信者情報を基に、規定のExcelテンプレートを使用して**注文書PDF**を生成する。
- 生成したPDFは、指定されたローカルフォルダに保存される。部署ごとにサブフォルダが設定されている場合は、そちらに保存される。
- ファイル名は「(タイムスタンプ)\_(仕入先名)\_注文書.pdf」形式で自動生成される。

### 2.4. メール送付機能

- 設定画面で登録されたSMTPアカウント情報を使用し、メールを送信する。
- 宛先（To, Cc）、件名、本文は、注文情報と固定テンプレートに基づいて自動的に設定される。
- 本文の署名には、会社情報に加え、選択された送信者の部署名と担当者名、ガイダンス番号が動的に挿入される。
- 生成された注文書PDFをメールに自動で添付する。

## 3. 非機能要件

### 3.1. 技術スタック・使用ライブラリ

- **プログラミング言語**: Python 3
- **GUIフレームワーク**: Tkinter
- **主要ライブラリ**:
    - `notion-client`: Notion APIとの通信
    - `win32com.client`: Excelテンプレートを操作しPDFを生成
    - `python-dotenv`: APIキーなどの設定管理
    - `keyring`: パスワードの安全な保管
    - その他 `requirements.txt` に記載のライブラリ

### 3.2. 設定管理

- **機密情報**: Notion APIキー、データベースID、Excelテンプレートのパスなどは、`.env`ファイルで管理する。
- **アプリケーション設定**: メールアカウント（表示名、メールアドレス）、部署、デフォルト送信者などの情報は `email_accounts.json` ファイルに保存される。ただし、セキュリティ向上のため、アカウントのパスワードはOSが提供するセキュアストレージ（Windows Credential Managerなど）に`keyring`ライブラリを介して安全に保管される。

### 3.3. 実行環境

- **Windows OS**
- **Microsoft Excel**がインストールされていること。
  （`win32com.client`ライブラリがExcelを操作するため）

### 3.4. 品質保証

本アプリケーションの品質を維持するため、自動テストを導入する。

- テストコードは`tests/`ディレクトリ内に格納される。
- `pytest`フレームワークを使用し、`email_service.py`や`pdf_generator.py`などの主要なロジックが期待通りに動作することを検証する。
- コードの変更後は、`pytest`コマンドを実行することで、既存機能への予期せぬ影響（リグレッション）がないことを確認できる。

## 4. ファイル構成

```
/
├── .gitignore
├── app_gui.py         # メインGUIの構築とイベント処理
├── config.py          # 設定情報(.env, .json)の読み込み、定数管理
├── email_service.py   # メール作成・送信処理
├── main.py            # アプリケーションのエントリーポイント
├── notion_api.py      # Notion APIとの連携処理
├── pdf_generator.py   # Excelテンプレートからの注文書PDF生成処理
├── requirements.txt   # 依存ライブラリリスト
├── settings_gui.py    # 設定画面のGUIとロジック
├── 要件定義書.md      # このファイル
└── tests/             # 自動テストコード
    ├── test_email_service.py
    ├── test_notion_api.py
    └── test_pdf_generator.py
```
